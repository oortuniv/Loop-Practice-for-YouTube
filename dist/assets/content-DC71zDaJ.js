function y(){return document.querySelector("video")}function P(r=location.href){try{const t=new URL(r);return t.hostname==="youtu.be"?t.pathname.slice(1)||null:t.hostname.includes("youtube.com")&&t.searchParams.get("v")||null}catch{return null}}function M(){return P()!==null&&!location.pathname.includes("/shorts")}function N(){return new Promise(r=>{const t=y();if(t){r(t);return}const e=new MutationObserver(()=>{const i=y();i&&(e.disconnect(),r(i))});e.observe(document.body,{childList:!0,subtree:!0})})}function E(r){let t=location.href;const e=()=>{location.href!==t&&(t=location.href,r())};window.addEventListener("popstate",e);const i=history.pushState,n=history.replaceState;history.pushState=function(...o){i.apply(history,o),setTimeout(e,0)},history.replaceState=function(...o){n.apply(history,o),setTimeout(e,0)},document.addEventListener("yt-navigate-finish",e)}async function _(r){const t=`vid:${r}`,e=await chrome.storage.sync.get(t);if(e[t])return e[t];const i={videoId:r,defaultRate:1,segments:[],activeSegmentId:null,countInBeats:4,metronomeEnabled:!1};return await chrome.storage.sync.set({[t]:i}),i}async function $(r){const t=`vid:${r.videoId}`;await chrome.storage.sync.set({[t]:r})}function A(r,t,e){return Math.min(Math.max(r,t),e)}function D(r){if(!r||!r.tagName)return!1;const t=r.tagName.toLowerCase();return["input","textarea","select"].includes(t)||r.contentEditable==="true"||r.isContentEditable}function I(r,t){let e;return function(...i){e||(r.apply(this,i),e=!0,setTimeout(()=>e=!1,t))}}var R=Object.defineProperty,L=(r,t,e)=>t in r?R(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,f=(r,t,e)=>L(r,typeof t!="symbol"?t+"":t,e);class k{constructor(t,e){f(this,"video"),f(this,"profile"),f(this,"active"),f(this,"tickThrottled"),this.video=t,this.profile=e,this.tickThrottled=I(()=>this.tick(),50),e.activeSegmentId&&this.setActive(e.activeSegmentId)}setProfile(t){this.profile=t,console.log("LoopController setProfile:",{activeSegmentId:t.activeSegmentId,segmentsCount:t.segments.length}),this.setActive(t.activeSegmentId)}setActive(t){this.profile.activeSegmentId=t??null,this.active=this.profile.segments.find(e=>e.id===t)||void 0,this.applyActiveRate(),this.active?console.log(`루프 활성화: ${this.active.label} (${this.active.start}s ~ ${this.active.end}s)`):console.log("루프 비활성화")}getActive(){return this.active}getProfile(){return this.profile}tick(){if(!this.active){console.log("루프 체크: 활성 구간 없음");return}const{start:t,end:e}=this.active,i=this.video.currentTime;if(i==null||isNaN(i)||typeof i!="number"){console.log("루프 체크: currentTime이 유효하지 않음",i);return}i>=e&&(console.log(`루프 점프: ${i.toFixed(2)}s → ${t.toFixed(2)}s`),this.video.currentTime=t,this.video.paused&&(console.log("루프 점프 후 재생 시작"),this.video.play().catch(n=>{console.error("루프 점프 후 재생 실패:",n)})))}onTimeUpdate(){this.tickThrottled()}gotoPrevNext(t){const e=this.video.currentTime;if(e==null||isNaN(e)||typeof e!="number"){console.log("gotoPrevNext: currentTime이 유효하지 않음",e);return}const i=[...this.profile.segments].sort((n,o)=>n.start-o.start);if(i.length!==0){if(t>0){const n=i.find(o=>o.start>e)??i[0];this.setActive(n==null?void 0:n.id),n&&(this.video.currentTime=n.start)}else{const n=[...i].reverse().find(o=>o.start<e)??i[i.length-1];this.setActive(n==null?void 0:n.id),n&&(this.video.currentTime=n.start)}this.applyActiveRate()}}applyActiveRate(){var i;const t=typeof this.profile.defaultRate=="number"&&!isNaN(this.profile.defaultRate)?this.profile.defaultRate:1,e=((i=this.active)==null?void 0:i.rate)??t;this.video.playbackRate=e}createSegmentFromCurrentTime(t,e){const i=this.video.currentTime;if(i==null||isNaN(i)||typeof i!="number")return console.log("createSegmentFromCurrentTime: currentTime이 유효하지 않음",i),null;const n=typeof this.profile.defaultRate=="number"&&!isNaN(this.profile.defaultRate)?this.profile.defaultRate:1;if(t==="start"){const o=Math.min(i+10,this.video.duration);let l=e;if(!l){const a=Math.floor(i/60),c=Math.floor(i%60),u=Math.floor(o/60),d=Math.floor(o%60);l=`${a}:${c.toString().padStart(2,"0")}~${u}:${d.toString().padStart(2,"0")}`}const s={id:Math.random().toString(36).substring(2,15),start:i,end:o,rate:n,label:l};return this.profile.segments.push(s),s}else{const o=this.profile.segments[this.profile.segments.length-1];if(o&&o.start<i){if(o.end=i,!o.label||o.label.startsWith("구간 ")){const l=Math.floor(o.start/60),s=Math.floor(o.start%60),a=Math.floor(i/60),c=Math.floor(i%60);o.label=`${l}:${s.toString().padStart(2,"0")}~${a}:${c.toString().padStart(2,"0")}`}return o}}return null}updateSegment(t,e){var n;const i=this.profile.segments.find(o=>o.id===t);return i?(Object.assign(i,e),((n=this.active)==null?void 0:n.id)===t&&this.applyActiveRate(),!0):!1}deleteSegment(t){var i;const e=this.profile.segments.findIndex(n=>n.id===t);return e===-1?!1:(this.profile.segments.splice(e,1),((i=this.active)==null?void 0:i.id)===t&&this.setActive(null),!0)}setDefaultRate(t){this.profile.defaultRate=t,this.applyActiveRate()}getSegmentAtCurrentTime(){const t=this.video.currentTime;if(t==null||isNaN(t)||typeof t!="number"){console.log("getSegmentAtCurrentTime: currentTime이 유효하지 않음",t);return}return this.profile.segments.find(e=>t>=e.start&&t<=e.end)}}var B=Object.defineProperty,F=(r,t,e)=>t in r?B(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,p=(r,t,e)=>F(r,typeof t!="symbol"?t+"":t,e);class V{constructor(){p(this,"ctx"),p(this,"running",!1),p(this,"nextTime",0),p(this,"scheduleTimeout")}start(t){if(this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.running)return;const e=this.ctx;this.running=!0;const i=60/t;this.nextTime=e.currentTime+.05;const n=()=>{if(!this.running||!e)return;const o=e.currentTime;for(;this.nextTime<o+.15;)this.click(this.nextTime,t),this.nextTime+=i;this.scheduleTimeout=setTimeout(n,25)};n()}stop(){this.running=!1,this.scheduleTimeout&&(clearTimeout(this.scheduleTimeout),this.scheduleTimeout=void 0)}click(t,e){if(!this.ctx)return;const i=this.ctx,n=i.createOscillator(),o=i.createGain();Math.floor(t*e/60)%4===0?(n.frequency.value=800,o.gain.value=.3):(n.frequency.value=1200,o.gain.value=.15);const s=.01,a=.05,c=.7,u=.1;o.gain.setValueAtTime(0,t),o.gain.linearRampToValueAtTime(o.gain.value,t+s),o.gain.exponentialRampToValueAtTime(c*o.gain.value,t+s+a),o.gain.exponentialRampToValueAtTime(.001,t+s+a+u),n.connect(o).connect(i.destination),n.start(t),n.stop(t+s+a+u)}changeBpm(t){this.running&&(this.stop(),this.start(t))}isRunning(){return this.running}suspend(){var t;(t=this.ctx)==null||t.suspend()}resume(){var t;(t=this.ctx)==null||t.resume()}}var z=Object.defineProperty,O=(r,t,e)=>t in r?z(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,w=(r,t,e)=>O(r,typeof t!="symbol"?t+"":t,e);class U{constructor(){w(this,"ctx"),w(this,"running",!1)}async run(t){const{beats:e,bpm:i,onComplete:n}=t;if(this.running)return;this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.running=!0;const o=60/i,l=this.ctx.currentTime+.1;for(let a=0;a<e;a++){const c=l+a*o;this.playCountInClick(c,a===0)}const s=l+e*o;setTimeout(()=>{this.running=!1,n()},(s-this.ctx.currentTime)*1e3)}playCountInClick(t,e){if(!this.ctx)return;const i=this.ctx,n=i.createOscillator(),o=i.createGain();e?(n.frequency.value=600,o.gain.value=.4):(n.frequency.value=1e3,o.gain.value=.2);const l=.05;o.gain.setValueAtTime(0,t),o.gain.linearRampToValueAtTime(o.gain.value,t+.01),o.gain.exponentialRampToValueAtTime(.001,t+l),n.connect(o).connect(i.destination),n.start(t),n.stop(t+l)}isRunning(){return this.running}stop(){this.running=!1}}var Y=Object.defineProperty,G=(r,t,e)=>t in r?Y(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,T=(r,t,e)=>G(r,typeof t!="symbol"?t+"":t,e);class q{constructor(){T(this,"ctx"),T(this,"taps",[]),T(this,"lastTapTime",0)}tapTempo(){const t=Date.now();if((this.taps.length===0||t-this.lastTapTime>3e3)&&(this.taps=[]),this.taps.push(t),this.lastTapTime=t,this.taps.length<2)return null;const e=[];for(let o=1;o<this.taps.length;o++)e.push(this.taps[o]-this.taps[o-1]);const i=e.reduce((o,l)=>o+l,0)/e.length,n=Math.round(6e4/i);return Math.max(60,Math.min(200,n))}clearTaps(){this.taps=[]}getTapCount(){return this.taps.length}async detectFromVideo(t,e=3){try{this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext));let i;try{const u=t.captureStream();i=this.ctx.createMediaStreamSource(u)}catch{return null}const n=this.ctx.createAnalyser();n.fftSize=2048,i.connect(n);const o=n.frequencyBinCount,l=new Uint8Array(o),s=[],a=Date.now(),c=50;return new Promise(u=>{const d=()=>{if(Date.now()-a>e*1e3){const v=this.calculateBpmFromSamples(s);u(v);return}n.getByteFrequencyData(l);const C=l.reduce((v,x)=>v+x,0)/o;s.push(C),setTimeout(d,c)};d()})}catch(i){return console.warn("BPM 감지 실패:",i),null}}calculateBpmFromSamples(t){if(t.length<20)return null;const e=Math.max(...t)*.7,i=[];for(let s=1;s<t.length-1;s++)t[s]>e&&t[s]>t[s-1]&&t[s]>t[s+1]&&i.push(s);if(i.length<3)return null;const n=[];for(let s=1;s<i.length;s++)n.push(i[s]-i[s-1]);const o=n.reduce((s,a)=>s+a,0)/n.length,l=Math.round(6e4/(o*50));return Math.max(60,Math.min(200,l))}}var K=Object.defineProperty,W=(r,t,e)=>t in r?K(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,h=(r,t,e)=>W(r,typeof t!="symbol"?t+"":t,e);class H{constructor(){h(this,"video"),h(this,"videoId"),h(this,"profile"),h(this,"loopController"),h(this,"metronome",new V),h(this,"countIn",new U),h(this,"bpmDetector",new q),h(this,"isInitialized",!1),h(this,"saveProfileThrottled"),this.saveProfileThrottled=I(()=>this.saveProfile(),1e3),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),console.log("Content Script 메시지 리스너 등록 완료")}async init(){if(!this.isInitialized)try{if(console.log("YouTubeLoopPractice 초기화 시작"),!M()){console.log("YouTube watch 페이지가 아님, 초기화 건너뜀");return}if(console.log("YouTube watch 페이지 확인됨"),this.video=await N(),!this.video){console.log("비디오 요소를 찾을 수 없음");return}console.log("비디오 요소 발견:",this.video);const t=P();if(!t){console.log("비디오 ID를 추출할 수 없음");return}this.videoId=t,console.log("비디오 ID:",t),this.profile=await _(this.videoId),console.log("프로필 로드 완료:",this.profile),this.loopController=new k(this.video,this.profile),console.log("루프 컨트롤러 초기화 완료"),this.setupEventListeners(),console.log("이벤트 리스너 설정 완료"),E(()=>{console.log("YouTube 네비게이션 감지, 정리 후 재초기화"),this.cleanup(),setTimeout(()=>this.init(),1e3)}),this.isInitialized=!0,console.log("YouTube Loop & Practice 초기화 완료"),this.profile.activeSegmentId&&(console.log("활성 구간 복원:",this.profile.activeSegmentId),this.loopController.setActive(this.profile.activeSegmentId))}catch(t){console.error("초기화 실패:",t)}}setupEventListeners(){!this.video||!this.loopController||(console.log("이벤트 리스너 설정 시작"),this.video.addEventListener("timeupdate",()=>{var t;(t=this.loopController)==null||t.onTimeUpdate()}),console.log("timeupdate 이벤트 리스너 등록 완료"),window.addEventListener("keydown",this.handleKeydown.bind(this)),console.log("모든 이벤트 리스너 설정 완료"))}handleKeydown(t){if(D(t.target))return;switch(t.key.toLowerCase()){case" ":t.preventDefault(),this.togglePlay();break;case"l":t.preventDefault(),this.toggleLoop();break;case"[":t.preventDefault(),this.gotoSegment(-1);break;case"]":t.preventDefault(),this.gotoSegment(1);break;case"-":case"_":t.preventDefault(),this.changeRate(-.05);break;case"=":case"+":t.preventDefault(),this.changeRate(.05);break;case"b":t.preventDefault(),this.toggleBpmDetection();break;case"m":t.preventDefault(),this.toggleMetronome();break;case"c":t.preventDefault(),this.runCountIn();break;case"t":t.preventDefault(),this.tapTempo();break}}handleMessage(t,e,i){var n;try{if(console.log("Content Script 메시지 수신:",t),(t==null?void 0:t.type)==="PING")return console.log("PING 메시지 수신, 응답 전송"),i({status:"ok",timestamp:Date.now(),initialized:this.isInitialized}),!0;if((t==null?void 0:t.type)==="GET_CURRENT_TIME"){const o=((n=this.video)==null?void 0:n.currentTime)||0;return console.log("현재 시간 요청:",o),i({currentTime:o}),!0}if(!this.isInitialized)return console.log("Content Script가 초기화되지 않음, 메시지 무시:",t==null?void 0:t.type),i({error:"Content script not initialized"}),!0;if((t==null?void 0:t.type)==="COMMAND"){switch(t.command){case"toggle-play":this.togglePlay();break;case"toggle-loop":this.toggleLoop();break;case"prev-segment":this.gotoSegment(-1);break;case"next-segment":this.gotoSegment(1);break;case"decrease-speed":this.changeRate(-.05);break;case"increase-speed":this.changeRate(.05);break;case"toggle-metronome":this.toggleMetronome();break;case"count-in":this.runCountIn();break;case"tap-tempo":this.tapTempo();break;case"set-segment-end":this.setSegmentEnd();break}i({success:!0})}else if((t==null?void 0:t.type)==="SET_BPM")this.setBpm(t.bpm),i({success:!0});else if((t==null?void 0:t.type)==="CREATE_SEGMENT"){const o=this.createSegment(t.label);i({success:!!o,segment:o})}else if((t==null?void 0:t.type)==="ACTIVATE_SEGMENT")this.activateSegment(t.segmentId),i({success:!0});else if((t==null?void 0:t.type)==="DELETE_SEGMENT"){const o=this.deleteSegment(t.segmentId);i({success:o})}else if((t==null?void 0:t.type)==="UPDATE_SEGMENT"){const o={};t.label!==void 0&&(o.label=t.label),t.start!==void 0&&(o.start=t.start),t.end!==void 0&&(o.end=t.end),t.rate!==void 0&&(o.rate=t.rate);const l=this.updateSegment(t.segmentId,o);i({success:l})}else(t==null?void 0:t.type)==="GET_STATE"?i({profile:this.profile}):(console.log("알 수 없는 메시지 타입:",t==null?void 0:t.type),i({error:"Unknown message type"}))}catch(o){console.error("메시지 처리 중 오류:",o),i({error:o instanceof Error?o.message:"Unknown error"})}return!0}togglePlay(){this.video&&(this.video.paused?this.video.play().catch(()=>{}):this.video.pause())}toggleLoop(){var e;if(!this.profile||!this.loopController)return;if(this.profile.segments.find(i=>i.id===this.profile.activeSegmentId))this.updateProfile(i=>{i.activeSegmentId=null});else{const i=(e=this.video)==null?void 0:e.currentTime;if(i==null||isNaN(i)||typeof i!="number"){console.log("toggleLoop: currentTime이 유효하지 않음",i);return}const n=this.profile.segments.find(o=>i>=o.start&&i<=o.end);n&&this.updateProfile(o=>{o.activeSegmentId=n.id})}}gotoSegment(t){this.loopController&&this.loopController.gotoPrevNext(t)}changeRate(t){if(!this.profile)return;const e=typeof this.profile.defaultRate=="number"&&!isNaN(this.profile.defaultRate)?this.profile.defaultRate:1,i=A(e+t,.25,2);this.updateProfile(n=>{n.defaultRate=i})}toggleBpmDetection(){!this.video||!this.profile||this.bpmDetector.detectFromVideo(this.video,3).then(t=>{t?(this.updateProfile(e=>{e.bpm=t}),console.log(`BPM 감지 완료: ${t}`)):console.log("BPM 감지 실패. 탭 템포를 사용하세요.")})}toggleMetronome(){var t;if(!((t=this.profile)!=null&&t.bpm)){console.log("BPM이 설정되지 않았습니다.");return}this.metronome.isRunning()?(this.metronome.stop(),this.updateProfile(e=>{e.metronomeEnabled=!1})):(this.metronome.start(this.profile.bpm),this.updateProfile(e=>{e.metronomeEnabled=!0}))}runCountIn(){var e;if(!((e=this.profile)!=null&&e.bpm)||!this.video||!this.loopController){console.log("BPM이 설정되지 않았습니다.");return}const t=this.loopController.getActive();if(!t){console.log("활성 구간이 없습니다.");return}this.countIn.run({beats:this.profile.countInBeats||4,bpm:this.profile.bpm,onComplete:()=>{this.video&&t.start!==void 0&&!isNaN(t.start)?(this.video.currentTime=t.start,this.video.play().catch(()=>{})):console.log("runCountIn: activeSegment.start이 유효하지 않음",t.start)}})}tapTempo(){const t=this.bpmDetector.tapTempo();t&&(this.updateProfile(e=>{e.bpm=t}),console.log(`탭 템포 BPM: ${t}`))}setBpm(t){t>=60&&t<=200&&(this.updateProfile(e=>{e.bpm=t}),console.log(`BPM 설정: ${t}`))}createSegment(t){if(!this.video||!this.profile)return;const e=this.video.currentTime;if(e==null||isNaN(e)||typeof e!="number"){console.log("createSegment: currentTime이 유효하지 않음",e);return}const i=Math.min(e+10,this.video.duration),n=typeof this.profile.defaultRate=="number"&&!isNaN(this.profile.defaultRate)?this.profile.defaultRate:1;let o=t;if(!o){const s=Math.floor(e/60),a=Math.floor(e%60),c=Math.floor(i/60),u=Math.floor(i%60);o=`${s}:${a.toString().padStart(2,"0")}~${c}:${u.toString().padStart(2,"0")}`}const l={id:Math.random().toString(36).substring(2,15),start:e,end:i,rate:n,label:o};return this.updateProfile(s=>{s.segments=[...s.segments,l]}),console.log(`구간 생성: ${o}`),l}setSegmentEnd(){if(!this.video||!this.profile)return;const t=this.video.currentTime;if(t==null||isNaN(t)||typeof t!="number"){console.log("setSegmentEnd: currentTime이 유효하지 않음",t);return}const e=this.profile.segments[this.profile.segments.length-1];e&&e.start<t&&(this.updateProfile(i=>{i.segments=i.segments.map((n,o)=>o===i.segments.length-1?{...n,end:t}:n)}),console.log(`구간 끝점 설정: ${t}`))}activateSegment(t){this.profile&&this.updateProfile(e=>{e.activeSegmentId===t?(e.activeSegmentId=null,console.log(`구간 비활성화: ${t}`)):(e.activeSegmentId=t,console.log(`구간 활성화: ${t}`))})}deleteSegment(t){if(!this.loopController)return!1;const e=this.loopController.deleteSegment(t);return e&&this.saveProfileThrottled(),e}updateSegment(t,e){if(!this.loopController)return!1;const i={};e.label!==void 0&&(i.label=e.label),e.start!==void 0&&(i.start=e.start),e.end!==void 0&&(i.end=e.end),e.rate!==void 0&&(i.rate=e.rate);const n=this.loopController.updateSegment(t,i);return n&&this.saveProfileThrottled(),n}updateProfile(t){var e;this.profile&&(t(this.profile),console.log("프로필 업데이트:",{activeSegmentId:this.profile.activeSegmentId,segmentsCount:this.profile.segments.length}),(e=this.loopController)==null||e.setProfile(this.profile),this.saveProfileThrottled())}async saveProfile(){if(!this.profile)return;const t=3;let e=0;for(;e<t;)try{await $(this.profile);return}catch(i){if(e++,console.error(`프로필 저장 실패 (${e}/${t}):`,i),e<t){const n=Math.pow(2,e-1)*1e3;await new Promise(o=>setTimeout(o,n))}else console.error("프로필 저장 최종 실패")}}cleanup(){this.isInitialized=!1,this.metronome.stop(),this.countIn.stop(),this.video&&this.video.removeEventListener("timeupdate",()=>{}),window.removeEventListener("keydown",this.handleKeydown.bind(this)),chrome.runtime.onMessage.removeListener(this.handleMessage.bind(this)),console.log("YouTube Loop & Practice 정리 완료")}}const m=new H,g=()=>{if(console.log("Content Script 초기화 시작"),!M()){console.log("YouTube watch 페이지가 아님, 초기화 건너뜀");return}const r=()=>{document.querySelector("video")?(console.log("비디오 요소 발견, 확장 프로그램 초기화"),m.init().catch(e=>{console.error("확장 프로그램 초기화 실패:",e)})):(console.log("비디오 요소 대기 중..."),setTimeout(r,50))};r()};g();document.readyState==="loading"&&document.addEventListener("DOMContentLoaded",()=>{m.isInitialized||(console.log("DOMContentLoaded 후 초기화 시도"),g())});window.addEventListener("load",()=>{setTimeout(()=>{m.isInitialized||(console.log("페이지 로드 완료 후 추가 초기화 시도"),g())},200)});let b=location.href;const S=()=>{location.href!==b&&(b=location.href,console.log("YouTube 네비게이션 감지:",b),m.cleanup(),setTimeout(()=>{console.log("네비게이션 후 재초기화"),g()},500))};window.addEventListener("popstate",S);const J=history.pushState,Q=history.replaceState;history.pushState=function(...r){J.apply(history,r),setTimeout(S,0)};history.replaceState=function(...r){Q.apply(history,r),setTimeout(S,0)};export{H as YouTubeLoopPractice};
