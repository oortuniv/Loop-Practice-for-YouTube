(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();var p=Object.defineProperty,h=(l,t,e)=>t in l?p(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e,u=(l,t,e)=>h(l,typeof t!="symbol"?t+"":t,e);class g{constructor(){u(this,"tab"),u(this,"profile"),u(this,"handleSegmentClick",t=>{const e=t.target;if(e.tagName==="BUTTON"){const n=e.getAttribute("data-segment-id"),s=e.getAttribute("data-action");n&&s&&(s==="activate"?this.activateSegment(n):s==="delete"?this.deleteSegment(n):s==="edit-label"?this.editSegmentLabel(n):s==="set-start-time"?this.setSegmentStartTime(n):s==="set-end-time"?this.setSegmentEndTime(n):s==="edit-segment"?this.editSegment(n):s==="decrease-rate"?this.decreaseSegmentRate(n):s==="increase-rate"&&this.increaseSegmentRate(n))}}),u(this,"handleInputChange",t=>{const e=t.target;if(e.classList.contains("rate-input")){const n=e.getAttribute("data-segment-id");if(n){const s=parseFloat(e.value)/100;!isNaN(s)&&s>=.05&&s<=1.6&&this.updateSegmentRate(n,s)}}}),u(this,"handleInputBlur",t=>{const e=t.target;if(e.classList.contains("time-input")){const n=e.getAttribute("data-segment-id"),s=e.getAttribute("data-time-type");if(n&&s){const i=this.parseTimeInput(e.value);i!==null?s==="start"?this.updateSegmentStartTime(n,i):s==="end"&&this.updateSegmentEndTime(n,i):this.refreshState()}}}),u(this,"handleInputKeydown",t=>{const e=t.target;e.classList.contains("time-input")&&(t.key==="Enter"?e.blur():t.key==="Escape"&&this.refreshState())})}async init(){var t,e;try{console.log("팝업 초기화 시작");const[n]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(n!=null&&n.url)){console.log("탭 URL이 없음"),this.updateStatus("YouTube 페이지가 아닙니다","0개","설정 안됨");return}if(console.log("탭 정보:",{id:n.id,url:n.url}),this.tab=n,!(n.url.includes("youtube.com/watch")||n.url.includes("youtu.be/"))){console.log("YouTube watch 페이지가 아님:",n.url),this.updateStatus("YouTube watch 페이지가 아닙니다","0개","설정 안됨");return}const i=this.extractVideoId(n.url);if(!i){console.log("비디오 ID 추출 실패:",n.url),this.updateStatus("비디오 ID를 찾을 수 없습니다","0개","설정 안됨");return}console.log("비디오 ID:",i),this.profile=await this.loadProfile(i),this.updateStatus("YouTube watch 페이지",`${((t=this.profile)==null?void 0:t.segments.length)||0}개`,(e=this.profile)!=null&&e.bpm?`${this.profile.bpm} BPM`:"설정 안됨"),this.initializeUI(),this.setupEventListeners(),this.updateSegmentsList(),console.log("팝업 초기화 완료")}catch(n){console.error("팝업 초기화 실패:",n),this.updateStatus("오류 발생","0개","설정 안됨")}}updateStatus(t,e,n){const s=document.getElementById("currentPage"),i=document.getElementById("segmentCount"),r=document.getElementById("bpm");s&&(s.textContent=t),i&&(i.textContent=e),r&&(r.textContent=n)}extractVideoId(t){try{const e=new URL(t);return e.hostname==="youtu.be"?e.pathname.slice(1)||null:e.hostname.includes("youtube.com")?e.searchParams.get("v"):null}catch{return null}}async loadProfile(t){try{const e=`vid:${t}`;return(await chrome.storage.sync.get(e))[e]||{videoId:t,defaultRate:1,segments:[],activeSegmentId:null,bpm:null,countInBeats:4,metronomeEnabled:!1,schemaVersion:1}}catch{return{videoId:t,defaultRate:1,segments:[],activeSegmentId:null,bpm:null,countInBeats:4,metronomeEnabled:!1,schemaVersion:1}}}initializeUI(){if(!this.profile)return;const t=document.getElementById("currentRate");if(t){const n=typeof this.profile.defaultRate=="number"&&!isNaN(this.profile.defaultRate)?this.profile.defaultRate:1;t.textContent=`${n.toFixed(2)}x`}const e=document.getElementById("bpmInput");e&&this.profile.bpm&&(e.value=this.profile.bpm.toString())}setupEventListeners(){const t=document.getElementById("togglePlay");t&&t.addEventListener("click",()=>this.sendCommand("toggle-play"));const e=document.getElementById("toggleLoop");e&&e.addEventListener("click",()=>this.sendCommand("toggle-loop"));const n=document.getElementById("decreaseRate"),s=document.getElementById("increaseRate");n&&n.addEventListener("click",()=>this.sendCommand("decrease-speed")),s&&s.addEventListener("click",()=>this.sendCommand("increase-speed"));const i=document.getElementById("prevSegment"),r=document.getElementById("nextSegment");i&&i.addEventListener("click",()=>this.sendCommand("prev-segment")),r&&r.addEventListener("click",()=>this.sendCommand("next-segment"));const d=document.getElementById("setBpm");d&&d.addEventListener("click",()=>this.setBpm());const o=document.getElementById("tapTempo");o&&o.addEventListener("click",()=>this.sendCommand("tap-tempo"));const c=document.getElementById("toggleMetronome");c&&c.addEventListener("click",()=>this.sendCommand("toggle-metronome"));const a=document.getElementById("createSegment");a&&a.addEventListener("click",()=>this.createSegment());const m=document.getElementById("setSegmentEnd");m&&m.addEventListener("click",()=>this.sendCommand("set-segment-end"))}async ensureContentScriptReady(){var t;if(!((t=this.tab)!=null&&t.id))return console.error("탭 정보가 없습니다"),!1;for(let e=1;e<=3;e++)try{console.log(`Content Script 연결 확인 시도 ${e}/3`);const n=await chrome.tabs.sendMessage(this.tab.id,{type:"PING"});if(n&&n.status==="ok"){if(console.log("Content Script 연결 성공",n),n.initialized===!1){console.log("Content Script가 아직 초기화되지 않음, 대기 중..."),await new Promise(s=>setTimeout(s,500));continue}return!0}console.log("Content Script 응답이 올바르지 않음:",n)}catch(n){if(console.log(`Content Script 연결 실패 (시도 ${e}/3):`,n),e<3){const s=100*Math.pow(2,e-1);await new Promise(i=>setTimeout(i,s))}}return console.error("Content Script 연결 실패 - 모든 시도 실패"),!1}async sendMessageToContentScript(t){var e;if(!((e=this.tab)!=null&&e.id))throw new Error("탭 정보가 없습니다");try{if(!await this.ensureContentScriptReady())throw new Error("Content script가 응답하지 않습니다");const n=await chrome.tabs.sendMessage(this.tab.id,t);if(n&&n.error)throw new Error(n.error);return n}catch(n){throw console.error("메시지 전송 실패:",n),n}}async sendCommand(t){try{await this.sendMessageToContentScript({type:"COMMAND",command:t}),setTimeout(()=>this.refreshState(),100)}catch(e){console.error("명령어 전송 실패:",e);const n=e instanceof Error&&e.message.includes("Receiving end does not exist")?"YouTube 페이지를 새로고침한 후 다시 시도해주세요.":"명령어 실행에 실패했습니다.";this.showError(n)}}async setBpm(){var n;const t=document.getElementById("bpmInput");if(!t||!((n=this.tab)!=null&&n.id))return;const e=parseInt(t.value);if(e>=60&&e<=200)try{await this.sendMessageToContentScript({type:"SET_BPM",bpm:e}),setTimeout(()=>this.refreshState(),100)}catch(s){console.error("BPM 설정 실패:",s)}}async createSegment(){var n,s,i;const t=document.getElementById("segmentLabel");if(!t||!((n=this.tab)!=null&&n.id))return;let e=t.value;if(!e)try{const r=await this.sendMessageToContentScript({type:"GET_CURRENT_TIME"});(r==null?void 0:r.currentTime)!==void 0?e=this.formatTime(r.currentTime):e=`구간 ${(s=this.profile)!=null&&s.segments.length?this.profile.segments.length+1:1}`}catch(r){console.error("현재 시간 가져오기 실패:",r),e=`구간 ${(i=this.profile)!=null&&i.segments.length?this.profile.segments.length+1:1}`}try{await this.sendMessageToContentScript({type:"CREATE_SEGMENT",label:e}),t.value="",setTimeout(()=>this.refreshState(),100)}catch(r){console.error("구간 생성 실패:",r)}}async refreshState(){var t,e,n;if((t=this.tab)!=null&&t.id)try{const s=await this.sendMessageToContentScript({type:"GET_STATE"});s!=null&&s.profile&&(this.profile=s.profile,this.updateStatus("YouTube watch 페이지",`${((e=this.profile)==null?void 0:e.segments.length)||0}개`,(n=this.profile)!=null&&n.bpm?`${this.profile.bpm} BPM`:"설정 안됨"),this.initializeUI(),this.updateSegmentsList())}catch(s){console.error("상태 새로고침 실패:",s)}}updateSegmentState(t,e){this.profile&&(this.profile.activeSegmentId=e?t:null,this.updateSegmentsList())}updateSegmentsList(){if(!this.profile)return;const t=document.getElementById("segmentsList");t&&(t.innerHTML="",this.profile.segments.forEach(e=>{var o,c,a;const n=e.label||"구간",s=typeof e.start=="number"&&!isNaN(e.start)?e.start:0,i=typeof e.end=="number"&&!isNaN(e.end)?e.end:10,r=typeof e.rate=="number"&&!isNaN(e.rate)?e.rate:1,d=document.createElement("div");d.className=`segment-item ${e.id===((o=this.profile)==null?void 0:o.activeSegmentId)?"active":""}`,d.setAttribute("data-segment-id",e.id),d.innerHTML=`
        <div class="segment-info">
          <div class="segment-label">
            <span class="label-text">${n}</span>
            <button class="label-edit-btn" data-segment-id="${e.id}" data-action="edit-label">✏️</button>
          </div>
          <div class="segment-time">
            <div class="time-input-group">
              <span>시작:</span>
              <input type="text" class="time-input" data-segment-id="${e.id}" data-time-type="start" 
                     value="${this.formatTime(s)}" placeholder="0:00">
              <button class="time-set-btn" data-segment-id="${e.id}" data-action="set-start-time">현재</button>
            </div>
            <div class="time-input-group">
              <span>종료:</span>
              <input type="text" class="time-input" data-segment-id="${e.id}" data-time-type="end" 
                     value="${this.formatTime(i)}" placeholder="0:00">
              <button class="time-set-btn" data-segment-id="${e.id}" data-action="set-end-time">현재</button>
            </div>
          </div>
          <div class="rate-control-group">
            <span>속도:</span>
            <div class="rate-input-container">
              <button class="rate-btn" data-segment-id="${e.id}" data-action="decrease-rate">-</button>
              <input type="number" class="rate-input" data-segment-id="${e.id}" 
                     value="${Math.round(r*100)}" min="5" max="160" step="5">
              <span class="rate-unit">%</span>
              <button class="rate-btn" data-segment-id="${e.id}" data-action="increase-rate">+</button>
            </div>
          </div>
        </div>
        <div class="segment-actions">
          <button class="btn btn-small ${e.id===((c=this.profile)==null?void 0:c.activeSegmentId)?"btn-primary":""}" data-segment-id="${e.id}" data-action="activate">${e.id===((a=this.profile)==null?void 0:a.activeSegmentId)?"비활성화":"활성화"}</button>
          <button class="btn btn-small btn-edit" data-segment-id="${e.id}" data-action="edit-segment">편집</button>
          <button class="btn btn-small btn-danger" data-segment-id="${e.id}" data-action="delete">삭제</button>
        </div>
      `,t.appendChild(d)}),this.profile.segments.length===0&&(t.innerHTML='<div style="text-align: center; color: #6c757d; padding: 20px;">구간이 없습니다</div>'),this.setupSegmentEventListeners())}formatTime(t){if(typeof t!="number"||isNaN(t))return"0:00";const e=Math.floor(t/60),n=Math.floor(t%60);return`${e}:${n.toString().padStart(2,"0")}`}showError(t){const e=document.createElement("div");e.className="error-message",e.textContent=t,e.style.cssText=`
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #dc3545;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
      max-width: 300px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},5e3)}showSuccess(t){const e=document.createElement("div");e.className="success-message",e.textContent=t,e.style.cssText=`
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
      max-width: 300px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}setupSegmentEventListeners(){const t=document.getElementById("segmentsList");t&&(t.removeEventListener("click",this.handleSegmentClick),t.removeEventListener("input",this.handleInputChange),t.removeEventListener("change",this.handleInputChange),t.removeEventListener("blur",this.handleInputBlur),t.removeEventListener("keydown",this.handleInputKeydown),t.addEventListener("click",this.handleSegmentClick),t.addEventListener("input",this.handleInputChange),t.addEventListener("change",this.handleInputChange),t.addEventListener("blur",this.handleInputBlur),t.addEventListener("keydown",this.handleInputKeydown))}async activateSegment(t){var e;try{await this.sendMessageToContentScript({type:"ACTIVATE_SEGMENT",segmentId:t});const n=((e=this.profile)==null?void 0:e.activeSegmentId)===t;this.updateSegmentState(t,!n),setTimeout(()=>this.refreshState(),500)}catch(n){console.error("구간 활성화 실패:",n);const s=n instanceof Error&&n.message.includes("Receiving end does not exist")?"YouTube 페이지를 새로고침한 후 다시 시도해주세요.":"구간 활성화에 실패했습니다.";this.showError(s)}}async deleteSegment(t){try{await this.sendMessageToContentScript({type:"DELETE_SEGMENT",segmentId:t}),this.refreshState()}catch(e){console.error("구간 삭제 실패:",e);const n=e instanceof Error&&e.message.includes("Receiving end does not exist")?"YouTube 페이지를 새로고침한 후 다시 시도해주세요.":"구간 삭제에 실패했습니다.";this.showError(n)}}editSegmentLabel(t){var d;const e=document.querySelector(`[data-segment-id="${t}"]`);if(!e){console.error("구간 아이템을 찾을 수 없습니다:",t);return}const n=e.querySelector(".label-text");if(!n){console.error("라벨 요소를 찾을 수 없습니다");return}const s=n.textContent||"",i=document.createElement("input");i.type="text",i.className="label-input",i.value=s,(d=n.parentNode)==null||d.replaceChild(i,n),i.focus(),i.select();const r=()=>{var c;const o=i.value.trim();if(o&&o!==s)this.updateSegmentLabel(t,o);else{const a=document.createElement("span");a.className="label-text",a.textContent=s,(c=i.parentNode)==null||c.replaceChild(a,i)}};i.addEventListener("blur",r),i.addEventListener("keydown",o=>{var c;if(o.key==="Enter")r();else if(o.key==="Escape"){const a=document.createElement("span");a.className="label-text",a.textContent=s,(c=i.parentNode)==null||c.replaceChild(a,i)}})}async setSegmentStartTime(t){try{const e=await this.sendMessageToContentScript({type:"GET_CURRENT_TIME"});(e==null?void 0:e.currentTime)!==void 0&&!isNaN(e.currentTime)?this.updateSegmentStartTime(t,e.currentTime):this.showError("현재 시간을 가져올 수 없습니다.")}catch(e){console.error("현재 시간 가져오기 실패:",e),this.showError("현재 시간을 가져올 수 없습니다.")}}async setSegmentEndTime(t){try{const e=await this.sendMessageToContentScript({type:"GET_CURRENT_TIME"});(e==null?void 0:e.currentTime)!==void 0&&!isNaN(e.currentTime)?this.updateSegmentEndTime(t,e.currentTime):this.showError("현재 시간을 가져올 수 없습니다.")}catch(e){console.error("현재 시간 가져오기 실패:",e),this.showError("현재 시간을 가져올 수 없습니다.")}}async updateSegmentLabel(t,e){try{await this.sendMessageToContentScript({type:"UPDATE_SEGMENT",segmentId:t,label:e}),this.showSuccess("라벨이 수정되었습니다."),this.refreshState()}catch(n){console.error("라벨 수정 실패:",n),this.showError("라벨 수정에 실패했습니다.")}}async updateSegmentStartTime(t,e){try{await this.sendMessageToContentScript({type:"UPDATE_SEGMENT",segmentId:t,start:e}),this.showSuccess("시작 시간이 설정되었습니다."),this.refreshState()}catch(n){console.error("시작 시간 설정 실패:",n),this.showError("시작 시간 설정에 실패했습니다.")}}async updateSegmentEndTime(t,e){try{await this.sendMessageToContentScript({type:"UPDATE_SEGMENT",segmentId:t,end:e}),this.showSuccess("종료 시간이 설정되었습니다."),this.refreshState()}catch(n){console.error("종료 시간 설정 실패:",n),this.showError("종료 시간 설정에 실패했습니다.")}}async updateSegmentRate(t,e){try{await this.sendMessageToContentScript({type:"UPDATE_SEGMENT",segmentId:t,rate:e});const n=document.querySelector(`[data-segment-id="${t}"] .rate-input`);n&&(n.value=`${Math.round(e*100)}`)}catch(n){console.error("재생속도 설정 실패:",n),this.showError("재생속도 설정에 실패했습니다.")}}parseTimeInput(t){const e=t.trim();if(!e)return null;const n=e.split(":");if(n.length===2){const i=parseInt(n[0],10),r=parseInt(n[1],10);return!isNaN(i)&&!isNaN(r)&&i>=0&&r>=0&&r<60?i*60+r:null}const s=parseInt(e,10);return!isNaN(s)&&s>=0?s:null}editSegment(t){const e=document.querySelector(`[data-segment-id="${t}"]`);if(!e){console.error("구간 아이템을 찾을 수 없습니다:",t);return}e.classList.contains("edit-mode")?(e.classList.remove("edit-mode"),this.showSuccess("편집 모드가 종료되었습니다.")):(e.classList.add("edit-mode"),this.showSuccess("편집 모드가 활성화되었습니다. 시간과 속도를 직접 편집할 수 있습니다."))}decreaseSegmentRate(t){var i;const e=(i=this.profile)==null?void 0:i.segments.find(r=>r.id===t);if(!e)return;const n=e.rate,s=Math.max(.05,n-.05);this.updateSegmentRate(t,s)}increaseSegmentRate(t){var i;const e=(i=this.profile)==null?void 0:i.segments.find(r=>r.id===t);if(!e)return;const n=e.rate,s=Math.min(1.6,n+.05);this.updateSegmentRate(t,s)}}const f=new g;document.addEventListener("DOMContentLoaded",()=>{f.init()});
